# Moltbot Worker 部署教程

本教程记录了将 Moltbot 部署到 Cloudflare Workers 的完整步骤。

## 前置要求

- [Cloudflare Workers Paid 计划](https://www.cloudflare.com/plans/developer-platform/)（$5/月）
- Docker Desktop 已安装并运行
- Node.js 和 npm 已安装
- Cloudflare AI Gateway 已配置（或使用 Anthropic API）

## 环境信息

- **Account ID**: `your-cloudflare-account-id`
- **子域**: `your-subdomain.workers.dev`
- **Worker 名称**: `moltbot-sandbox`
- **部署 URL**: `https://moltbot-sandbox.your-subdomain.workers.dev`

## 步骤 1: 安装依赖

```bash
npm install
```

## 步骤 2: 配置 Secrets

### 2.1 必需的 Secrets

#### MOLTBOT_GATEWAY_TOKEN（网关访问令牌）
```bash
# 生成随机令牌（64位十六进制）
# PowerShell: -join ((48..57) + (97..102) | Get-Random -Count 64 | ForEach-Object {[char]$_})
# Linux/Mac: openssl rand -hex 32
echo "your-generated-gateway-token-here" | npx wrangler secret put MOLTBOT_GATEWAY_TOKEN
```

#### CF_ACCOUNT_ID（Cloudflare 账户 ID）
```bash
echo "your-cloudflare-account-id" | npx wrangler secret put CF_ACCOUNT_ID
```

#### CF_ACCESS_TEAM_DOMAIN（Cloudflare Access 团队域）
```bash
echo "your-team.cloudflareaccess.com" | npx wrangler secret put CF_ACCESS_TEAM_DOMAIN
```

#### CF_ACCESS_AUD（Cloudflare Access 应用 AUD）
```bash
echo "your-access-application-aud-tag" | npx wrangler secret put CF_ACCESS_AUD
```

### 2.2 R2 持久化存储配置

#### R2_ACCESS_KEY_ID（R2 访问密钥 ID）
```bash
echo "your-r2-access-key-id" | npx wrangler secret put R2_ACCESS_KEY_ID
```

#### R2_SECRET_ACCESS_KEY（R2 访问密钥）
```bash
echo "your-r2-secret-access-key" | npx wrangler secret put R2_SECRET_ACCESS_KEY
```

### 2.3 AI Gateway 配置（推荐）

#### AI_GATEWAY_API_KEY（AI Gateway API 密钥）
```bash
echo "your-ai-gateway-api-key" | npx wrangler secret put AI_GATEWAY_API_KEY
```

#### AI_GATEWAY_BASE_URL（AI Gateway 端点 URL）
```bash
echo "https://gateway.ai.cloudflare.com/v1/your-account-id/your-gateway-name/compat" | npx wrangler secret put AI_GATEWAY_BASE_URL
```

**或者使用 Anthropic API（二选一）：**
```bash
echo "sk-ant-你的密钥" | npx wrangler secret put ANTHROPIC_API_KEY
```

### 2.4 开发模式配置（可选）

如果遇到 Cloudflare Access 问题，可以临时启用开发模式：

```bash
echo "true" | npx wrangler secret put DEV_MODE
```

> **注意**: DEV_MODE 会跳过 Cloudflare Access 认证和设备配对，仅用于测试环境。

## 步骤 3: 清理旧容器（如果存在）

如果之前部署过，需要先删除旧容器：

### 3.1 列出现有容器
```bash
npx wrangler containers list
```

### 3.2 删除旧容器
```bash
# 使用容器 ID 删除
npx wrangler containers delete <容器ID>

# 例如：
# npx wrangler containers delete a03879f1-4a97-4320-84b6-5ae0f2a0edf5
# npx wrangler containers delete a03c79ba-0fe7-497f-b8de-e1bcb5c0af25
```

## 步骤 4: 拉取 Docker 基础镜像

确保 Docker Desktop 正在运行，然后拉取基础镜像：

```bash
docker pull docker.io/cloudflare/sandbox:0.7.0
```

## 步骤 5: 部署到 Cloudflare

```bash
npm run deploy
```

部署过程包括：
1. 构建前端（Vite）
2. 构建 Worker
3. 上传静态资源
4. 构建 Docker 镜像
5. 部署容器应用

部署成功后会显示：
```
✨ SUCCESS  Created application moltbot-sandbox-sandbox
Deployed moltbot-sandbox triggers
  https://moltbot-sandbox.your-subdomain.workers.dev
```

## 步骤 6: 访问应用

### Control UI（Moltbot 聊天界面）

访问 URL（带 token）：
```
https://moltbot-sandbox.your-subdomain.workers.dev/?token=your-gateway-token
```

> **首次访问提示**: 首次请求可能需要 1-2 分钟来启动容器，请耐心等待。

### 管理界面（设备管理）

访问 URL：
```
https://moltbot-sandbox.your-subdomain.workers.dev/_admin/
```

> **注意**: 如果启用了 DEV_MODE，可以直接访问。否则需要先配置 Cloudflare Access。

## 常见问题

### 1. Docker 连接错误

**错误信息**: `The Docker CLI could not be launched`

**解决方案**:
- 确保 Docker Desktop 已安装并正在运行
- 检查 Docker 守护进程是否启动

### 2. 容器命名冲突

**错误信息**: `There is already an application with the name...`

**解决方案**:
```bash
# 列出所有容器
npx wrangler containers list

# 删除冲突的容器
npx wrangler containers delete <容器ID>
```

### 3. Cloudflare Access 认证问题

**错误信息**: `Please contact your administrator to enable the Access App Launcher`

**解决方案**:

**方案 A（临时测试）**: 启用开发模式
```bash
echo "true" | npx wrangler secret put DEV_MODE
```

**方案 B（生产环境）**: 正确配置 Cloudflare Access
1. 访问 [Cloudflare Zero Trust Dashboard](https://one.dash.cloudflare.com/)
2. 进入 **Access** > **Applications**
3. 创建或配置应用：
   - 应用域名: `moltbot-sandbox.your-subdomain.workers.dev`
   - 保护路径: `/_admin/*`, `/api/*`
   - 添加允许的用户/邮箱

### 4. Docker 镜像拉取失败

**错误信息**: `Error response from daemon: Get "https://registry.cloudflare.com/v2/": EOF`

**解决方案**:
```bash
# 手动拉取基础镜像
docker pull docker.io/cloudflare/sandbox:0.7.0

# 然后重新部署
npm run deploy
```

### 5. 缺少 API 密钥

**错误信息**: `Missing Variables: ANTHROPIC_API_KEY or AI_GATEWAY_API_KEY`

**解决方案**: 二选一配置

**选项 1: 使用 AI Gateway**
```bash
echo "你的API密钥" | npx wrangler secret put AI_GATEWAY_API_KEY
echo "你的网关URL" | npx wrangler secret put AI_GATEWAY_BASE_URL
```

**选项 2: 使用 Anthropic API**
```bash
echo "sk-ant-你的密钥" | npx wrangler secret put ANTHROPIC_API_KEY
```

## 重新部署

如果需要更新代码或配置，只需运行：

```bash
npm run deploy
```

如果只是更新 secrets，不需要重新部署，secrets 会立即生效。

## 查看日志

实时查看 Worker 日志：

```bash
npx wrangler tail
```

## 查看已配置的 Secrets

```bash
npx wrangler secret list
```

## 删除 Worker

如果需要完全删除 Worker：

```bash
npx wrangler delete moltbot-sandbox
```

## 备份与恢复

### R2 数据持久化

应用配置了 R2 存储用于数据持久化，包括：
- Moltbot 配置文件
- 配对的设备信息
- 对话历史

每 5 分钟自动同步到 R2 bucket（通过 cron trigger）。

## 技术栈

- **运行时**: Cloudflare Workers + Sandbox 容器
- **前端**: React + Vite
- **后端框架**: Hono
- **AI**: Claude (通过 Anthropic API 或 AI Gateway)
- **存储**: R2 Object Storage
- **认证**: Cloudflare Access
- **容器**: Docker (基于 `cloudflare/sandbox:0.7.0`)

## 相关链接

- [Cloudflare Workers Dashboard](https://dash.cloudflare.com/?to=/:account/workers-and-pages)
- [Cloudflare Zero Trust Dashboard](https://one.dash.cloudflare.com/)
- [Cloudflare R2 Dashboard](https://dash.cloudflare.com/?to=/:account/r2)
- [Anthropic Console](https://console.anthropic.com/)
- [Moltbot 文档](https://docs.molt.bot/)

## 部署完成 ✅

现在你可以开始使用 Moltbot 了！

访问地址：
- **Control UI**: https://moltbot-sandbox.your-subdomain.workers.dev/?token=your-gateway-token
- **管理界面**: https://moltbot-sandbox.your-subdomain.workers.dev/_admin/
